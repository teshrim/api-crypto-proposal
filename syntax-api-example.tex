\begin{figure}
\begin{center}
\fpage{0.75}{
 % \todo{Specify \algfont{ENCRYPT} for completeness.}
  %
  %\\
\underline{\algfont{DECRYPT}(\rwordfont{var}\varfont{ChannelContext}, \varfont{Msg}):}
\begin{align*}
  &(\varfont{SentContext},\varfont{Ciphertext}) \gets\algfont{Deserialize}(\varfont{Msg})\\
  &(\varfont{ExternalVals, InternalVals}) \gets \algfont{Decrypt}(\rwordfont{var}\varfont{ChannelContext},\varfont{SentContext}, \varfont{Ciphertext})\\
  &\varfont{Verdict} \gets \algfont{IsValid}(\varfont{InternalVals})\\
  &\varfont{ExternalVals} \gets
                                  \algfont{ErrorHandling}(\rwordfont{var}\varfont{ChannelContext},
                                  \varfont{Verdict}, \varfont{ExternalVals})\\
  &\varfont{Return} \varfont{ ExternalVals}
\end{align*}
}
\end{center}
%
%\cpnote{I would call these \algfont{SendMessage} and \algfont{ReceiveMessage}
%instead of \algfont{ENCRYPT} and \algfont{DECRYPT}.}
%\cpnote{$\algfont{ParseReceived}$ would be called $\algfont{Unmarshal}$ or
%$\algfont{Deserialize}$ in modern programming languages. (To me this is like
%deserializing a protocol buffer.)}
%
\cpnote{Does \varfont{ExternalVals} encode the message?}\tsnote{It
  encodes whatever is to be returned, so yeah, typically the message.}
%
\todo{Note adoption of the ``call-by-reference''
  semantics of Rogaway-Stegers. 
}
\caption{Describing symmetric-key decryption of received message~\varfont{Msg} in terms of
  explicit functionalities that must be realized. The \varfont{ChannelContext}
  is receiver-maintained information about the channel, and may contain values
  shared with the sender (e.g., the key, channel ID), along with local state.
  The \varfont{SentContext} is context data associated to this particular
  ciphertext. The \varfont{ExternalVals} are intended to be released to the
  external caller, and the \varfont{InternalVals} are intended for use only
within the decryption process boundary.  The types of all input and output
values are implicit.}
\label{fig:syntax-api-example}
\end{figure}

\begin{figure}
\hfpages{0.55}
{
Given \varfont{ChannelContext}=\\[-0.5ex]
\nudge\nudge$\langle$ModeKey $K$, PRFKey $L$, ChannelStatus
``open''$\rangle$ 
%Given $\varfont{Msg} =\langle V,H,C \rangle$

\medskip
Algorithm \algfont{Deserialize}(\varfont{Msg}):\\
\nudge $V \gets \varfont{Msg}.V$; $H \gets \varfont{Msg}.H$; $C \gets
\varfont{Msg}.C$\\
\nudge Return $\left((V, H),C\right)$

\medskip
Algorithm \algfont{Decrypt}({\bf var} \varfont{ChannelContext},$(V,H)$, $C$):\\
\nudge Parse $C$ into tag $T$ and remainder $Z$\\ 
%\nudge $K \gets \varfont{ChannelContext.ModeKey}$\\
%\nudge $L \gets \varfont{ChannelContext.PRFKey}$\\
\nudge if $F_L(V,A,Z) \neq T$ then \varfont{InternalVals} $\gets$ ``TagFail''\\
\nudge\varfont{ExternalVals} $\gets \calD_K^{V}(Z)$\\
\nudge Return (\varfont{ExternalVals},\varfont{InternalVals})

\medskip
Algorithm \algfont{IsValid}(\varfont{InternalVals}):\\
\nudge \varfont{Verdict} $\gets$ ``Valid''\\
\nudge if \varfont{InternalVals} =  ``TagFail'' then \varfont{Verdict} $\gets$ ``Invalid''\\
\nudge Return \varfont{Verdict}

\medskip
Algorithm \algfont{ErrorHandling}({\bf var} \varfont{ChannelContext},\varfont{Verdict},\varfont{ExternalVals}):\\
\nudge if \varfont{Verdict} = ``Invalid'' then \\
\nudge\nudge \varfont{ExternalVals} $\gets$ ``Invalid'' \\
\nudge\nudge \varfont{ChannelContext.ChannelStatus} $\gets \langle
\mbox{Status ``closed"} \rangle$\\
\nudge Return \varfont{ExternalVals}
}
%
{
Given \varfont{ChannelContext}=\\[-0.5ex]
\nudge\nudge $\langle$ModeKey $K$, PRFKey $L$, ChannelStatus ``open'',
TokenList $ TL\rangle$
%Given $\varfont{Msg} =\langle V,H,C \rangle$

\medskip
Algorithm \algfont{Deserialize}(\varfont{Msg}):\\
\nudge $V \gets \varfont{Msg}.V$; $H \gets \varfont{Msg}.H$; $C \gets \varfont{Msg}.C$\\
\nudge $\mathrm{sid} \gets H.\varfont{StreamID}$\\
\nudge Return $\left((V, H, \mathrm{sid}),C\right)$
%\nudge Return $\left((V, H),C\right)$

\medskip
Algorithm \algfont{Decrypt}({\bf var} \varfont{ChannelContext},$(V,H,\mathrm{sid})$, $C$):\\
%\nudge $\varfont{ExternalVals} \gets H.\varfont{StreamID}$\\
\nudge Parse $C$ into tag $T$ and remainder $Z$\\ 
%\nudge $K \gets \varfont{ChannelContext.ModeKey}$\\
%\nudge $L \gets \varfont{ChannelContext.PRFKey}$\\
\nudge if $F_L(V,H,Z) \neq T$ then \varfont{InternalVals} $\gets$ ``TagFail''\\
\nudge $\mathrm{tid} \concat M \gets \calD_K^{V}(Z)$\\
\nudge if $\mathrm{tid}\not\in TL$ then\\
\nudge\nudge \varfont{InternalVals} $\gets \langle
\varfont{InternalVals}, \mbox{``BadToken"}, \mathrm{tid} \rangle$\\
\nudge \varfont{ExternalVals} $\gets \langle \mathrm{sid}, M \rangle$\\
\nudge Return (\varfont{ExternalVals},\varfont{InternalVals})

\medskip
Algorithm \algfont{IsValid}(\varfont{InternalVals}):\\
\nudge \varfont{Verdict} $\gets$ ``Valid''\\
\nudge if ``TagFail'' $\in$ \varfont{InternalVals} then \varfont{Verdict} $\gets$ ``Invalid''\\
\nudge if ``BadToken'' $\in$ \varfont{InternalVals} then \varfont{Verdict} $\gets \langle
\varfont{Verdict},\mbox{``BadToken"} \rangle$\\
\nudge Return \varfont{Verdict}

\medskip
Algorithm \algfont{ErrorHandling}({\bf var} \varfont{ChannelContext},\varfont{Verdict},\varfont{ExternalVals}):\\
\nudge if ``Invalid'' $\in$ \varfont{Verdict} then \\
\nudge\nudge \varfont{ExternalVals} $\gets$ ``Invalid'' \\
\nudge\nudge \varfont{ChannelContext.ChannelStatus} $\gets \langle
\mbox{Status ``closed"} \rangle$\\
\nudge else if ``BadToken'' $\in$ \varfont{Verdict} then \\
\nudge\nudge \varfont{ExternalVals} $\gets$ ``Invalid'' \\
\nudge\nudge \varfont{ChannelContext.ChannelStatus} $\gets$ none \\
\nudge Return \varfont{ExternalVals}
} 
%\tsnote{Is this actually useful for selling the ideas it is meant to sell?}
\caption{ {\bf
    Left:} Specification of Encrypt-then-MAC decryption over IV-based
  symmetric-key decryption $\calD$ and vector-input PRF~$F$. A tag-check failure results in the
suppression of all plaintext/errors output by $\calD^V_K(Z)$, and
causes a single error message to be exposed.  Also,
in the event of a tag-check failure, the error-handling algorithm
suggests that the Status of the channel context be updated to
``closed''.  Note that this specification carries out decryption
$\calD^V_K(Z)$ even if there is a tag-check failure, thereby hiding a
potential timing side-channel. 
%
{\bf
  Right: } [...]
}
\label{fig:EtM-aead}
\end{figure}
